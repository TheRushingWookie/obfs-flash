#!/usr/bin/python

import os
import sys
import time

from pyptlib.util.subproc import auto_killall, Popen
from subprocess import PIPE

auto_killall(1)

ob_client = os.getenv("OBFSPROXY", "obfsproxy")
fp_client = os.getenv("FLASHPROXY_CLIENT", "flashproxy-client")
fp_local_port = int(os.getenv("FLASHPROXY_LOCAL_PORT", 9001))
fp_remote_port = int(os.getenv("FLASHPROXY_REMOTE_PORT", 9000))

mid_port = 2334

managed_ver = os.getenv("TOR_PT_MANAGED_TRANSPORT_VER")
if managed_ver != "1":
    print "VERSION-ERROR no-version"
    sys.exit(1)
print "VERSION " + managed_ver

transports = os.getenv("TOR_PT_CLIENT_TRANSPORTS")

if transports not in ["obfs3_flash", "*"]:
    print "CMETHODS DONE"
    sys.exit(1)

cur_env = os.environ.items()

def writeSink():
    return open("/dev/null", "w", 0)

fp_proc = Popen(
    [fp_client, ":%s" % fp_local_port, ":%s" % fp_remote_port],
    stdout = writeSink(),
    env = dict(cur_env + {
        "TOR_PT_MANAGED_TRANSPORT_VER": managed_ver,
        #"TOR_PT_STATE_LOCATION": same,
        "TOR_PT_CLIENT_TRANSPORTS": "websocket",
    }.items()),
    )

mid_proc = Popen(
    ["socat",
     "TCP-LISTEN:%s,reuseaddr,fork,bind=127.0.0.1" % mid_port,
     "SOCKS4A:127.0.0.1:0.0.1.0:1,socksport=%s" % fp_local_port],
    stdout = writeSink(),
    )

ob_proc = Popen(
    [ob_client, "managed"],
    stdout = PIPE,
    env = dict(cur_env + {
        "TOR_PT_MANAGED_TRANSPORT_VER": managed_ver,
        #"TOR_PT_STATE_LOCATION": same,
        "TOR_PT_CLIENT_TRANSPORTS": "obfs3",
    }.items()),
    )

while 1:
    # readlines() has a stupid non-bypassable buffer which hangs everything
    line = ob_proc.stdout.readline()
    if not line: break
    # probably should import pyptlib for anything more complex
    (kw, args) = line.split(" ", 1)
    if kw == "VERSION":
        pass
    elif kw == "CMETHOD" and args.startswith("obfs3 "):
        sys.stdout.write(line.replace("CMETHOD obfs3 ", "CMETHOD obfs3_flash ", 1))
    else:
        sys.stdout.write(line)
    sys.stdout.flush()

ob_proc.wait()
